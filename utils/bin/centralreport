#!/bin/bash

# ------------------------------------------------------------
# CentralReport Unix/Linux - Binary script
# Alpha version. Don't use in production environment!
# ------------------------------------------------------------
# https://github.com/miniche/CentralReport/
# ------------------------------------------------------------

# This script launchs CentralReport with the right user.
# It can be added to the PATH.

if [ "Darwin" == $(uname -s) ]; then
    # Mac OS X

    # If the _centralreport system user doesn't exist, we can't launch CentralReport agent.
    USER_UNIQUE_ID=$(dscl . -list /Users UniqueID | grep _centralreport | awk '{print $2}')
    if [ -z ${USER_UNIQUE_ID} ]; then
        echo "Error: The _centralreport system user doesn't exist."
        echo "For security reasons, CentralReport can't be launched."
    else

        # Checking if the /var/run/centralreport/ directory already exist
        if [ ! -d '/var/run/centralreport' ]; then
            sudo mkdir /var/run/centralreport
            sudo chown -R _centralreport:_centralreport /var/run/centralreport
        fi

        sudo -u _centralreport /usr/local/lib/centralreport/centralreport.py $*
    fi

elif [ -f "/etc/debian_version" ] || [ -f "/etc/lsb-release" ]; then
    # Debian or Ubuntu

    # If the _centralreport system user doesn't exist, we can't launch CentralReport agent.
    CR_USER_FOUND=$(cat /etc/passwd | grep 'centralreport')
    if [ -z ${CR_USER_FOUND} ]; then
        echo "Error: The _centralreport system user doesn't exist."
        echo "For security reasons, CentralReport can't be launched."
    else
    # Checking if the /var/run/centralreport/ directory already exist
        if [ ! -d '/var/run/centralreport' ]; then
            mkdir /var/run/centralreport
            chown -R centralreport:centralreport /var/run/centralreport
        fi

        su centralreport -c "/usr/local/lib/centralreport/centralreport.py $*"
    fi

else
    echo "Sorry, your operating system isn't supported yet by CentralReport!"
fi


