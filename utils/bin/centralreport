#!/bin/bash

# ------------------------------------------------------------
# CentralReport Unix/Linux - Binary script
# Alpha version. Don't use in production environment!
# ------------------------------------------------------------
# https://github.com/miniche/CentralReport/
# ------------------------------------------------------------

# This script launchs CentralReport with the right user.
# It can be added to the PATH.

CR_DIR_PID=/var/run/centralreport

if [ $(uname -s) == "Darwin" ]; then
    # Mac OS X

    # If the _centralreport system user doesn't exist, we can't launch CentralReport agent.
    USER_UNIQUE_ID=$(dscl . -list /Users UniqueID | grep _centralreport | awk '{print $2}')
    if [ -z "${USER_UNIQUE_ID}" ]; then
        echo "Error: The _centralreport system user doesn't exist."
        echo "For security reasons, CentralReport can't be launched."
    else

        # Checking if the /var/run/centralreport/ directory already exist
        if [ ! -d ${CR_DIR_PID} ]; then
            sudo mkdir ${CR_DIR_PID}
            sudo chown -R _centralreport:_centralreport ${CR_DIR_PID}
        fi

        sudo -u _centralreport /usr/local/lib/centralreport/centralreport.py $*
    fi

elif [ -f "/etc/debian_version" ] || [ -f "/etc/lsb-release" ]; then
    # Debian or Ubuntu

    # If the _centralreport system user doesn't exist, we can't launch CentralReport agent.
    CR_USER_FOUND=$(cat /etc/passwd | grep 'centralreport')
    if [ -z "${CR_USER_FOUND}" ]; then
        echo "Error: The _centralreport system user doesn't exist."
        echo "For security reasons, CentralReport can't be launched."
    else

        # Checking if the /var/run/centralreport/ directory already exist
        if [ ! -d ${CR_DIR_PID} ]; then
            mkdir ${CR_DIR_PID}
            chown -R centralreport:centralreport ${CR_DIR_PID}
        fi

        su centralreport -c "python /usr/local/lib/centralreport/centralreport.py $*"
    fi

else
    echo "Sorry, your operating system isn't supported yet by CentralReport!"
fi


